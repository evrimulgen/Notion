


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Anonymziation &mdash; Notion: a PACS for researchers 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Notion: a PACS for researchers 1.0 documentation" href="../index.html"/>
        <link rel="next" title="Using Connectors" href="moving_images.html"/>
        <link rel="prev" title="DICOM Configuration" href="dicom.html"/>
<link rel="stylesheet" href="../_static/notion.css" />
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>

 


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Notion: a PACS for researchers</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#running-notion">Running Notion</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#create-a-user">Create a User</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#create-a-pool">Create a Pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#working-with-the-pool">Working with the pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#sending-images-to-the-pool">Sending images to the Pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dicom.html">DICOM Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dicom.html#device-setup">Device Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="dicom.html#store">Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="dicom.html#query">Query</a></li>
<li class="toctree-l2"><a class="reference internal" href="dicom.html#retrieve">Retrieve</a></li>
<li class="toctree-l2"><a class="reference internal" href="dicom.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Anonymziation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#scripts">Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anonymize-images">Anonymize Images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="moving_images.html">Using Connectors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="moving_images.html#configure-a-connector">Configure a Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="moving_images.html#performing-a-query">Performing a Query</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="use_cases.html">Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="use_cases.html#multi-researcher-multi-pool">Multi-Researcher / Multi-Pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_cases.html#irb-pool">IRB Pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_cases.html#research-pacs">Research PACS</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Reference/reference.html">Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Reference/reference.html#pool">Pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/reference.html#device">Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/reference.html#anonymization">Anonymization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/reference.html#connector">Connectors</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Development/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Development/metrics.html">Metrics and Monitoring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#dicom">DICOM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#query-fetch">Query / Fetch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#id1">Gauges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#id2">Counters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#id3">Meters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Development/metrics.html#id4">Timers</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Reference/operations.html">Operations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Reference/operations.html#dicom-configuration">DICOM Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/operations.html#authentication-and-authorization-configuration">Authentication and Authorization Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/operations.html#users-and-groups">Users and Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reference/operations.html#dbweb-interface">DBWeb Interface</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Notion: a PACS for researchers</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Anonymziation</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="anonymziation">
<span id="anonymizationintro"></span><h1>Anonymziation<a class="headerlink" href="#anonymziation" title="Permalink to this headline">Â¶</a></h1>
<p>To turn on Anonymization, click the <span class="tt">Edit</span> icon next to the Pool info on this page <a class="reference external" href="http://localhost:8080/index.html#/pools/pool/1">http://localhost:8080/index.html#/pools/pool/1</a>.  In the dialog box, check <span class="tt">Use Anonymizer</span>, click <span class="tt">Save changes</span> and <span class="tt">close</span>.  Now our Pool display looks somewhat different with two new sections: <span class="tt">CTP Configuration</span> and <span class="tt">Anonymization Rules</span>.  Opening up the <span class="tt">CTP Configuration</span> reveals an editor for the CTP configuration used by the pool.  The particular file is for the <a class="reference external" href="http://mircwiki.rsna.org/index.php?title=The_CTP_DICOM_Anonymizer">CTP DICOM anonymizer</a> configuration stored on the Notion server.  Editing and saving the file will change how anonymization is handled on the Notion server.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/ctp_configuration.png"><img alt="../_images/ctp_configuration.png" src="../_images/ctp_configuration.png" style="width: 768px;" /></a>
</div>
<p>Configuration of the <a class="reference external" href="http://mircwiki.rsna.org/index.php?title=The_CTP_DICOM_Anonymizer">CTP DICOM anonymizer</a>.  Changes will be saved to the server and used for anonymization of incoming DICOM images.</p>
<p>CTP is the first stage of the anonymization process in Notion.  The second stage is a <a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">Javascript</a> snippits that are used to substitute DICOM tags.  To demonstrate, we will look at the standard anonymization script.</p>
<p>By default, the context in which the Javascript snippit executes has a map called <span class="tt">tags</span>.  The <span class="tt">tags</span> hash map contains the original tag values for the current image (that is, before CTP Anonymization as CTP removes/changes many tags).</p>
<div class="figure align-center">
<img alt="../_images/editing_anonymization_rule.png" src="../_images/editing_anonymization_rule.png" />
</div>
<p>The editor has some nifty features, including saving the rule and trial execution of the rule.  Pressing <span class="tt">&#8216;Ctrl-S&#8217;</span> on Windows or <span class="tt">&#8216;Command-S&#8217;</span> on the Mac will save the rule, while pressing <span class="tt">&#8216;Ctrl-Return&#8217;</span> will execute the rule&#8217;s Javascript on the server with dummy values for the <span class="tt">tags</span> hash.  To try it out, run the script.  The output should be <span class="tt">&#8220;{AccessionNumber=LOOKUP, PatientName=LOOKUP, PatientID=LOOKUP}&#8221;</span>. The standard script is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span> <span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;PN-&#39;</span> <span class="o">+</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span><span class="p">),</span>
  <span class="nx">PatientID</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientID</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientID</span><span class="p">),</span>
  <span class="nx">AccessionNumber</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;AccessionNumber&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">AccessionNumber</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;AccessionNumber&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">AccessionNumber</span><span class="p">),</span>
 <span class="p">};</span>
 <span class="c1">// Return the tags hash</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="scripts">
<h2>Scripts<a class="headerlink" href="#scripts" title="Permalink to this headline">Â¶</a></h2>
<p>Scripts are written in Javascript.  To anonymize an image, Notion runs the Javascript and looks for the value of the last statement.  If the value is an associative array, the keys are used to look up particular DICOM tags (<code class="docutils literal"><span class="pre">PatientName</span></code>, <code class="docutils literal"><span class="pre">PatientID</span></code>, etc) and replace with the corresponding value in the output DICOM image.  In the standard script, <code class="docutils literal"><span class="pre">PatientName</span></code>, <code class="docutils literal"><span class="pre">PatientID</span></code> and <code class="docutils literal"><span class="pre">AccessionNumber</span></code> are replaced.</p>
<p>And give the script a trial run.  The result should be <span class="tt">&#8220;{AccessionNumber=LOOKUP, PatientName=LOOKUP, PatientID=LOOKUP}&#8221;</span>.  The <code class="docutils literal"><span class="pre">anonymizer.lookup</span></code> function returns a previously stored value for the PatientName corresponding to the PatientName tag in the incoming image (<code class="docutils literal"><span class="pre">tags.PatientName</span></code>).  If we remove the lookup code:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="s1">&#39;PN-&#39;</span> <span class="o">+</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span><span class="p">),</span>
  <span class="nx">PatientID</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientID</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientID</span><span class="p">),</span>
  <span class="nx">AccessionNumber</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;AccessionNumber&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">AccessionNumber</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;AccessionNumber&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">AccessionNumber</span><span class="p">),</span>
 <span class="p">};</span>
 <span class="c1">// Return the tags hash</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<p>and click <em>Try Script</em>, the result is ::tt::<cite>&#8220;{AccessionNumber=LOOKUP, PatientName=PN-42, PatientID=LOOKUP}&#8221;</cite>.  This is because <code class="docutils literal"><span class="pre">tags.PatientName</span></code> returns <span class="tt">#PatientName#</span> as a string and <code class="docutils literal"><span class="pre">anonymizer.sequenceNumber('PatientName',</span> <span class="pre">tags.PatientName)</span></code> always returns the string <span class="tt">&#8216;42&#8217;</span>.  They are concatenated using <code class="docutils literal"><span class="pre">+</span> <span class="pre">'-'</span> <span class="pre">+</span></code> to form the output string.  The <code class="docutils literal"><span class="pre">anonymizer</span></code> object is available in the Javascript and contains many useful functions.  Apart from the trial execution, <code class="docutils literal"><span class="pre">anonymizer.sequenceNumber(</span> <span class="pre">Type,</span> <span class="pre">Key</span> <span class="pre">)</span></code> first attempts to retrieve a previously stored sequence number indexed by <code class="docutils literal"><span class="pre">Type</span></code> ( <span class="tt">PatientName</span> in our case) and <code class="docutils literal"><span class="pre">Key</span></code> (<span class="tt">tags.PatientName</span>).  If found, the previous number is returned, otherwise a new sequence number is generated, stored for later use and returned.  Multiple sequences can be independantly maintained by the <code class="docutils literal"><span class="pre">Type</span></code> argument, or a single sequence can be used.</p>
<p>Enter this code in the <span class="tt">PatientName</span> key:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">hash</span> <span class="p">(</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span> <span class="p">),</span>
<span class="p">};</span>
<span class="c1">// 1234</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<p>The result of the trial execution is <code class="docutils literal"><span class="pre">&quot;{PatientName=3382174773882}&quot;</span></code>.  This is the <a class="reference external" href="http://en.wikipedia.org/wiki/MD5">MD5 hash</a> of the input string, <code class="docutils literal"><span class="pre">tags.PatientName</span></code> in the example.  The function <code class="docutils literal"><span class="pre">anonymizer.hash</span> <span class="pre">(</span> <span class="pre">Key,</span> <span class="pre">[length]</span> <span class="pre">)</span></code> returns the first <code class="docutils literal"><span class="pre">length</span></code> digits of the MD5 hash value of <code class="docutils literal"><span class="pre">Key</span></code>.  If we change our function to be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">hash</span> <span class="p">(</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="p">};</span>
<span class="c1">// 1234</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<p>Trial execution gives <code class="docutils literal"><span class="pre">&quot;{PatientName=338}&quot;</span></code> the first 3 digits of the full hash value from the previous script.</p>
<p>The <code class="docutils literal"><span class="pre">anonymizer</span></code> object has several other functions</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">debug(text)</span> <span class="pre">/</span> <span class="pre">info(text)</span> <span class="pre">/</span> <span class="pre">warn(text)</span> <span class="pre">/</span> <span class="pre">error(text)</span></code></dt>
<dd>Print a debug / info / warn / error message to the log</dd>
<dt><code class="docutils literal"><span class="pre">hash(text,[length])</span></code></dt>
<dd>Return a string containing the first <code class="docutils literal"><span class="pre">length</span></code> digits of the MD5 hash of <code class="docutils literal"><span class="pre">text</span></code> (default length is all characters)</dd>
<dt><code class="docutils literal"><span class="pre">setValue(Type,Key,Value)</span></code></dt>
<dd>Store a <code class="docutils literal"><span class="pre">Value</span></code> for later <code class="docutils literal"><span class="pre">lookup</span></code>.  <code class="docutils literal"><span class="pre">Value</span></code> is indexed by <code class="docutils literal"><span class="pre">Type</span></code> and <code class="docutils literal"><span class="pre">Key</span></code>.  The previous <code class="docutils literal"><span class="pre">Value</span></code> is overwritten by this method</dd>
<dt><code class="docutils literal"><span class="pre">lookup(Type,Key)</span></code></dt>
<dd>Lookup and return a value indexed by <code class="docutils literal"><span class="pre">Type</span></code> and <code class="docutils literal"><span class="pre">Key</span></code>.  If the value does not exist, <code class="docutils literal"><span class="pre">lookup</span></code> returns null</dd>
<dt><code class="docutils literal"><span class="pre">sequenceNumber(Type,Key)</span></code></dt>
<dd>First lookup the sequence number indexed by <code class="docutils literal"><span class="pre">Type</span></code> and <code class="docutils literal"><span class="pre">Value</span></code>.  If it does not exist, generate a unique number by incrementing the <code class="docutils literal"><span class="pre">Type</span></code> sequence.  For instance the first time <code class="docutils literal"><span class="pre">anonymizer.sequenceNumber('PatientName',</span> <span class="pre">'Jones')</span></code> is called, the return value is the string <code class="docutils literal"><span class="pre">'1'</span></code>.  On the second call, <code class="docutils literal"><span class="pre">anonymizer.sequenceNumber('PatientName',</span> <span class="pre">'Jones')</span></code> also returns the string <code class="docutils literal"><span class="pre">'1'</span></code>, however <code class="docutils literal"><span class="pre">anonymizer.sequenceNumber('PatientName',</span> <span class="pre">'Smith')</span></code> returns the string <code class="docutils literal"><span class="pre">'2'</span></code>.  Sequence numbers are used to generate <code class="docutils literal"><span class="pre">PatientName</span></code> and <code class="docutils literal"><span class="pre">PatientID</span></code> tags if particular identifiers are not required.  <em>NB:</em> see the <a class="reference internal" href="../Reference/reference.html#anonymization"><span>anonymizer reference</span></a> for details on prepopulating the lookup tables.</dd>
<dt><code class="docutils literal"><span class="pre">Exception(text)</span></code></dt>
<dd>Throw an exception, immediately stopping any further processing of this image.  Exceptions can be used to reject images that do not have proper lookup information.</dd>
</dl>
<p>Coming back to our example, set the anonymization rule for <code class="docutils literal"><span class="pre">PatientName</span></code> to be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Generate a sequence number for PatientName</span>
<span class="kd">var</span> <span class="nx">sequenceNumberString</span> <span class="o">=</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span> <span class="p">)</span>
<span class="c1">// Convert to an Integer</span>
<span class="kd">var</span> <span class="nx">sequenceNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">(</span> <span class="nx">sequenceNumberString</span> <span class="p">)</span>
<span class="c1">// Zero pad</span>
<span class="kd">var</span> <span class="nx">padded</span> <span class="o">=</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">format</span> <span class="p">(</span> <span class="s2">&quot;%05d&quot;</span><span class="p">,</span> <span class="nx">sequenceNumber</span> <span class="p">)</span>
<span class="c1">// Final output is Study-#####</span>
<span class="kd">var</span> <span class="nx">pn</span> <span class="o">=</span> <span class="s1">&#39;Study-&#39;</span> <span class="o">+</span> <span class="nx">sequenceNumber</span>


<span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="nx">pn</span><span class="p">,</span>
<span class="p">};</span>
<span class="c1">// 1234</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<p>This will set the PatientName to be a concatination of the string <code class="docutils literal"><span class="pre">'Study-'</span></code> and the zero padded string stored in <code class="docutils literal"><span class="pre">padded</span></code>.  Functions can also be used in anonymization rules:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">pad</span> <span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">(</span> <span class="nx">s</span> <span class="p">)</span>
  <span class="c1">// Zero pad</span>
  <span class="k">return</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">format</span> <span class="p">(</span> <span class="s2">&quot;%0&quot;</span> <span class="o">+</span> <span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nx">n</span> <span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Generate a sequence number for PatientName</span>
<span class="kd">var</span> <span class="nx">sequenceNumber</span> <span class="o">=</span> <span class="nx">pad</span> <span class="p">(</span> <span class="nx">anonymizer</span><span class="p">.</span><span class="nx">sequenceNumber</span> <span class="p">(</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">PatientName</span> <span class="p">),</span> <span class="mi">5</span> <span class="p">)</span>

<span class="c1">// Final output is Study-#####</span>
<span class="kd">var</span> <span class="nx">pn</span> <span class="o">=</span> <span class="s1">&#39;Study-&#39;</span> <span class="o">+</span> <span class="nx">sequenceNumber</span>

<span class="c1">// Default anonymization script</span>
<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">PatientName</span><span class="o">:</span> <span class="nx">pn</span><span class="p">,</span>
<span class="p">};</span>
<span class="c1">// 1234</span>
<span class="nx">tags</span><span class="p">;</span>
</pre></div>
</div>
<p>Remember, the tag replacement hash is the last statement of the Javascript and should consist of key-value pairs where the key is the DICOM tag to replace with the value.</p>
</div>
<div class="section" id="anonymize-images">
<h2>Anonymize Images<a class="headerlink" href="#anonymize-images" title="Permalink to this headline">Â¶</a></h2>
<p>The moment we&#8217;ve all been waiting for (yea right).  With our anonymizer in place, send the same data through Notion into the <code class="docutils literal"><span class="pre">test</span></code> Pool.</p>
<div class="highlight-bash"><div class="highlight"><pre>&gt;&gt; java -classpath lib:<span class="s2">&quot;lib/*&quot;</span> org.dcm4che2.tool.dcmsnd.DcmSnd <span class="nb">test</span>@localhost:11117 /path/to/DICOM/data/
Scanning files to send
     ....................................................................................................................................................................
     Scanned <span class="m">164</span> files in 0.214s <span class="o">(=</span>1ms/file<span class="o">)</span>
     INFO - Association<span class="o">(</span>1<span class="o">)</span> initiated Socket<span class="o">[</span><span class="nv">addr</span><span class="o">=</span>localhost/127.0.0.1,port<span class="o">=</span>11117,localport<span class="o">=</span>60448<span class="o">]</span>
     INFO - <span class="nb">test</span><span class="o">(</span>1<span class="o">)</span>: A-ASSOCIATE-RQ <span class="nb">test</span> <span class="s">&lt;&lt; DCMSND</span>
<span class="s">     INFO - test(1): A-ASSOCIATE-AC DCMSND</span> &gt;&gt; <span class="nb">test</span>
<span class="nb">     </span>Connected to <span class="nb">test</span>@localhost:11117 in 0.069s
     ....................................................................................................................................................................
     Sent <span class="m">164</span> objects <span class="o">(=</span>3.0736637MB<span class="o">)</span> in 5.895s <span class="o">(=</span>533.91547KB/s<span class="o">)</span>
     INFO - <span class="nb">test</span><span class="o">(</span>1<span class="o">)</span> <span class="s">&lt;&lt; A-RELEA</span>SE-RQ
     INFO - <span class="nb">test</span><span class="o">(</span>1<span class="o">)</span> &gt;&gt; A-RELEASE-RP
     Released connection to <span class="nb">test</span>@localhost:11117
     INFO - <span class="nb">test</span><span class="o">(</span>1<span class="o">)</span>: close Socket<span class="o">[</span><span class="nv">addr</span><span class="o">=</span>localhost/127.0.0.1,port<span class="o">=</span>11117,localport<span class="o">=</span>60448<span class="o">]</span>
</pre></div>
</div>
<p><a class="reference external" href="http://localhost:8080/index.html#/pools/studies/1">Viewing the studies</a> for the <code class="docutils literal"><span class="pre">test</span></code> Pool gives:</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../_images/anonymized_images.png"><img alt="../_images/anonymized_images.png" src="../_images/anonymized_images.png" style="width: 768px;" /></a>
<p class="caption"><span class="caption-text">Anonymized and non-anonymized images.  <span class="tt">MRA-0068</span> is the original patient study, and <span class="tt">Study-00001</span> is the anonymized version.</span></p>
</div>
<p>If the same images were sent again, they would receive the same PatientID, AccessionNumber and Study Description.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="moving_images.html" class="btn btn-neutral float-right" title="Using Connectors">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dicom.html" class="btn btn-neutral" title="DICOM Configuration"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, William Ryan, Patricio Fajnwaks, Daniel Blezek, Steve Langer, Brad Erickson.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>